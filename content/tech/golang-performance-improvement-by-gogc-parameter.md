+++
date = "2017-04-06T19:50:31+09:00"
draft = true
title = "Go言語で GOGC を指定して実行時間を削減する"
tags = ['go']
+++

# 結論

前提としては、サーバなどの長期間稼動するプログラムでなく、ファイルを変換するようなプログラムでの話です。

短命なデータが多い場合は `GOGC` 環境変数を指定してヒープを多めに使うようにすると実行時間が減るかもしれません。

コマンドの例：

```
GOGC=400 ./main
```
<!--more-->

# 背景

TSV ファイルから JSON ファイルを生成するプログラムを書いたときの話です。
具体的な処理は以下のような感じで、

1. 参照用のデータファイルを読み込む
1. 処理対象の TSV ファイルを読み込み、何行分かをまとめ構造化して出力
1. 処理対象の TSV ファイルがなくなるまで繰り返し

構造化のため構造体を割り当てますが、出力すれば不要になるため、
短命なデータがめちゃくちゃ多いという処理でした。

CPU profile の top10 を見てみるとやはり GC の処理で時間を食っているようでした。
たとえばマーク処理に関わる部分を抜き出してみると、

```
      flat  flat%   sum%        cum   cum%
      ...
    10.68s  7.35% 14.81%     11.84s  8.15%  runtime.greyobject
     9.64s  6.64% 21.44%      9.64s  6.64%  runtime.heapBitsForObject
      ...
     6.38s  4.39% 42.48%     27.81s 19.15%  runtime.scanobject
```

となって `18%` くらいありました。

処理対象のファイルは2000個くらいあり、サイズも展開後全体で 30 GB ほどで

# GOGC の意味

前回のGCで生き残った

[Package runtime: Environment Variables](https://golang.org/pkg/runtime/)
[GolangのGCを追う](http://deeeet.com/writing/2016/05/08/gogc-2016/)
