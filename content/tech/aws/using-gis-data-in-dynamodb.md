+++
date = "2017-08-18T18:07:21+09:00"
draft = true
title = "DynamoDB で地理情報を扱うライブラリを使ってみた"
tags = ["aws"]
+++

DynamoDB を地理情報データベースとして利用するためのライブラリがあります。

* [【AWS発表】 Amazon DynamoDB用のジオライブラリを公開](http://aws.typepad.com/aws_japan/2013/09/new-geo-library-for-dynamodb-.html)
* [Geo Library for Amazon DynamoDB – Part 1: Table Structure](https://aws.amazon.com/jp/blogs/mobile/geo-library-for-amazon-dynamodb-part-1-table-structure/)

本記事は、これを使うにあたり色々調べたことのメモです。

<!--more-->

まず、なぜ DynamoDB で地理情報を扱いたいのか、という話ですが、
自分の理解では「ダウンタイムなしで水平スケールしたいから」ということになります。
まあ地理情報に限った話ではなく、フルマネージドサービスである DynamoDB を使えると色々うれしいということです。

しかしながら DynamoDB は空間インデックスをサポートしていないので、
格納したデータに地理情報が含まれていても、
「現在地から半径500m以内のものを取得する」といったクエリが実行できません。

ということでこうしたクエリを実現するためにはこちら側での工夫が必要になります。
工夫は主に以下のふたつです。

* データ投入時、緯度・経度に基きジオコードを追加
* ジオコードに基いたクエリの実行できる LSI の作成

# 空間インデックス

ユースケース：現在地から半径500m以内にあるデータを探す

単純にやると、全てのデータと現在地との距離を計算して抽出することになります。
このやり方ではデータ数が増えた際に破綻します。

そこで、近いデータをまとめておいて、その塊ごとに判定することでざっくり絞りこむ、
というアプローチが有効です。

# グリッドによる空間インデックス(Geohash など)

地図をセルに分割し、IDをふります。
このとき、地理的に近いセルが似たようなIDを持つようにします。
セルのIDは1次元の値なので、RDB で標準的に用いられる B 木によるインデックスが使えます。

半径検索をする場合、この範囲をカバーするセルのIDを列挙します。
ここで、近いセルのIDが似たようなものであるため、
`BETWEEN x AND y` といった範囲指定のクエリを利用でき、効率良くデータを取得できます。
ただし厳密な半径検索ではないため、このざっくり取得したデータに対して厳密な絞り込みを追加します。

Google の S2 ライブラリの場合、球面を6枚に分け、あとは4分割を繰り返すことでセルを決定します。
最小のセルは 0.48cm2 です。

# DynamoDB 用ジオライブラリの仕組み

* パーティションキー： Geohash の prefix
* ソートキー： ユニークなID
